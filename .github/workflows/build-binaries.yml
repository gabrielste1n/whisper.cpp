name: Build Binaries for OpenWhispr

on:
  workflow_dispatch:
    inputs:
      version_tag:
        description: 'Version tag for release (e.g., v1.0.0)'
        required: true
        type: string
  push:
    tags:
      - 'openwhispr-*'

permissions:
  contents: write

jobs:
  build-macos-arm64:
    runs-on: macos-14  # M1 runner
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build whisper.cpp
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DWHISPER_METAL=ON \
            -DGGML_METAL=ON \
            -DBUILD_SHARED_LIBS=OFF
          cmake --build build --config Release -j $(sysctl -n hw.logicalcpu)

      - name: Package binaries
        run: |
          mkdir -p dist
          # whisper-cli
          cp build/bin/whisper-cli dist/whisper-cpp-darwin-arm64
          chmod +x dist/whisper-cpp-darwin-arm64
          # whisper-server
          cp build/bin/whisper-server dist/whisper-server-darwin-arm64
          chmod +x dist/whisper-server-darwin-arm64
          # Create zips
          cd dist
          zip whisper-cpp-darwin-arm64.zip whisper-cpp-darwin-arm64
          zip whisper-server-darwin-arm64.zip whisper-server-darwin-arm64

      - name: Upload whisper-cli artifact
        uses: actions/upload-artifact@v4
        with:
          name: whisper-cpp-darwin-arm64
          path: dist/whisper-cpp-darwin-arm64.zip

      - name: Upload whisper-server artifact
        uses: actions/upload-artifact@v4
        with:
          name: whisper-server-darwin-arm64
          path: dist/whisper-server-darwin-arm64.zip

  build-macos-x64:
    runs-on: macos-14  # Cross-compile for x64 on arm64 runner
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build whisper.cpp for x64
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES=x86_64 \
            -DWHISPER_METAL=OFF \
            -DGGML_METAL=OFF \
            -DGGML_NATIVE=OFF \
            -DBUILD_SHARED_LIBS=OFF
          cmake --build build --config Release -j $(sysctl -n hw.logicalcpu)

      - name: Package binaries
        run: |
          mkdir -p dist
          # whisper-cli
          cp build/bin/whisper-cli dist/whisper-cpp-darwin-x64
          chmod +x dist/whisper-cpp-darwin-x64
          # whisper-server
          cp build/bin/whisper-server dist/whisper-server-darwin-x64
          chmod +x dist/whisper-server-darwin-x64
          # Create zips
          cd dist
          zip whisper-cpp-darwin-x64.zip whisper-cpp-darwin-x64
          zip whisper-server-darwin-x64.zip whisper-server-darwin-x64

      - name: Upload whisper-cli artifact
        uses: actions/upload-artifact@v4
        with:
          name: whisper-cpp-darwin-x64
          path: dist/whisper-cpp-darwin-x64.zip

      - name: Upload whisper-server artifact
        uses: actions/upload-artifact@v4
        with:
          name: whisper-server-darwin-x64
          path: dist/whisper-server-darwin-x64.zip

  build-windows-x64:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Build whisper.cpp
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=OFF
          cmake --build build --config Release -j $env:NUMBER_OF_PROCESSORS

      - name: Package binaries
        run: |
          mkdir dist
          # whisper-cli
          copy build\bin\Release\whisper-cli.exe dist\whisper-cpp-win32-x64.exe
          # whisper-server
          copy build\bin\Release\whisper-server.exe dist\whisper-server-win32-x64.exe
          # Create zips
          cd dist
          Compress-Archive -Path whisper-cpp-win32-x64.exe -DestinationPath whisper-cpp-win32-x64.zip
          Compress-Archive -Path whisper-server-win32-x64.exe -DestinationPath whisper-server-win32-x64.zip

      - name: Upload whisper-cli artifact
        uses: actions/upload-artifact@v4
        with:
          name: whisper-cpp-win32-x64
          path: dist/whisper-cpp-win32-x64.zip

      - name: Upload whisper-server artifact
        uses: actions/upload-artifact@v4
        with:
          name: whisper-server-win32-x64
          path: dist/whisper-server-win32-x64.zip

  build-linux-x64:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake

      - name: Build whisper.cpp
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=OFF \
            -DGGML_NATIVE=OFF
          cmake --build build --config Release -j $(nproc)

      - name: Package binaries
        run: |
          mkdir -p dist
          # whisper-cli
          cp build/bin/whisper-cli dist/whisper-cpp-linux-x64
          chmod +x dist/whisper-cpp-linux-x64
          # whisper-server
          cp build/bin/whisper-server dist/whisper-server-linux-x64
          chmod +x dist/whisper-server-linux-x64
          # Create zips
          cd dist
          zip whisper-cpp-linux-x64.zip whisper-cpp-linux-x64
          zip whisper-server-linux-x64.zip whisper-server-linux-x64

      - name: Upload whisper-cli artifact
        uses: actions/upload-artifact@v4
        with:
          name: whisper-cpp-linux-x64
          path: dist/whisper-cpp-linux-x64.zip

      - name: Upload whisper-server artifact
        uses: actions/upload-artifact@v4
        with:
          name: whisper-server-linux-x64
          path: dist/whisper-server-linux-x64.zip

  create-release:
    needs: [build-macos-arm64, build-macos-x64, build-windows-x64, build-linux-x64]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir release
          # whisper-cli binaries
          mv artifacts/whisper-cpp-darwin-arm64/whisper-cpp-darwin-arm64.zip release/
          mv artifacts/whisper-cpp-darwin-x64/whisper-cpp-darwin-x64.zip release/
          mv artifacts/whisper-cpp-win32-x64/whisper-cpp-win32-x64.zip release/
          mv artifacts/whisper-cpp-linux-x64/whisper-cpp-linux-x64.zip release/
          # whisper-server binaries
          mv artifacts/whisper-server-darwin-arm64/whisper-server-darwin-arm64.zip release/
          mv artifacts/whisper-server-darwin-x64/whisper-server-darwin-x64.zip release/
          mv artifacts/whisper-server-win32-x64/whisper-server-win32-x64.zip release/
          mv artifacts/whisper-server-linux-x64/whisper-server-linux-x64.zip release/
          ls -la release/

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version_tag }}" >> $GITHUB_OUTPUT
          else
            echo "version=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: OpenWhispr Binaries ${{ steps.version.outputs.version }}
          body: |
            Pre-built whisper.cpp binaries for OpenWhispr.

            ## whisper-cli binaries (transcription command-line tool)
            - `whisper-cpp-darwin-arm64.zip` - macOS Apple Silicon (M1/M2/M3)
            - `whisper-cpp-darwin-x64.zip` - macOS Intel
            - `whisper-cpp-win32-x64.zip` - Windows x64
            - `whisper-cpp-linux-x64.zip` - Linux x64

            ## whisper-server binaries (HTTP server for faster repeated transcriptions)
            - `whisper-server-darwin-arm64.zip` - macOS Apple Silicon (M1/M2/M3)
            - `whisper-server-darwin-x64.zip` - macOS Intel
            - `whisper-server-win32-x64.zip` - Windows x64
            - `whisper-server-linux-x64.zip` - Linux x64

            ## Usage
            Extract the binaries and place them in your PATH or use them directly.

            The whisper-server provides an HTTP API for transcription, which is faster
            for repeated use as it keeps the model loaded in memory.
          files: release/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
